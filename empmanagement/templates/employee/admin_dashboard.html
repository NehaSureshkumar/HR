{% extends 'employee/base.html' %}

{% block title %}HR Dashboard - Employee Management System{% endblock %}

{% block content %}
<header class="flex items-center justify-between bg-white shadow px-6 py-4 sticky top-0 z-10">
    <div class="flex items-center space-x-4">
        <img src="/static/images/logo.png" alt="Logo" class="h-8 w-8 rounded-full shadow" />
        <span class="text-2xl font-bold text-blue-700 font-sans tracking-tight">Dashboard Overview</span>
    </div>
    <div class="flex items-center space-x-4">
        <button class="relative group" title="Notifications">
            <span class="material-icons text-gray-500 text-2xl">notifications</span>
            <span class="absolute top-0 right-0 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>
            <span class="sr-only">Notifications</span>
        </button>
        <div class="relative group">
            <img src="https://ui-avatars.com/api/?name={{ user_profile.user.get_full_name|urlencode }}" alt="Profile" class="w-10 h-10 rounded-full border shadow cursor-pointer" />
            <div class="absolute right-0 mt-2 w-40 bg-white rounded shadow-lg py-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-20">
                <div class="px-4 py-2 text-gray-700 font-medium">{{ user_profile.user.get_full_name }}</div>
                <div class="border-t"></div>
                <a href="{% url 'profile' %}" class="block px-4 py-2 text-gray-600 hover:bg-gray-100">My Profile</a>
                <a href="/accounts/logout/" class="block px-4 py-2 text-gray-600 hover:bg-gray-100">Logout</a>
            </div>
        </div>
                </div>
</header>
<main class="flex-1 p-6 bg-gradient-to-br from-gray-50 via-white to-blue-50 min-h-screen font-sans">
    <!-- Dashboard Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="dashboard-card bg-gradient-to-br from-green-100 to-green-50 rounded-xl shadow-lg p-5 flex flex-col items-start border-l-4 border-green-400">
            <div class="text-xs text-gray-500 mb-1">Ongoing Active Hirings</div>
            <div class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-green-700">+{{ active_hirings }}</span>
                <span class="bg-green-200 text-green-800 text-xs px-2 py-1 rounded">On Track</span>
            </div>
                </div>
        <div class="dashboard-card bg-gradient-to-br from-blue-100 to-blue-50 rounded-xl shadow-lg p-5 flex flex-col items-start border-l-4 border-blue-400">
            <div class="text-xs text-gray-500 mb-1">Employee Count</div>
            <div class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-blue-700">{{ total_employees }}</span>
                <span class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded">Stable</span>
            </div>
                </div>
        <div class="dashboard-card bg-gradient-to-br from-yellow-100 to-yellow-50 rounded-xl shadow-lg p-5 flex flex-col items-start border-l-4 border-yellow-400">
            <div class="text-xs text-gray-500 mb-1">Ongoing Projects</div>
            <div class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-yellow-700">{{ ongoing_projects.count }}</span>
                <span class="bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded">At Risk</span>
            </div>
        </div>
        <div class="dashboard-card bg-gradient-to-br from-orange-100 to-orange-50 rounded-xl shadow-lg p-5 flex flex-col items-start border-l-4 border-orange-400">
            <div class="text-xs text-gray-500 mb-1">Upcoming Projects</div>
            <div class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-orange-700">{{ upcoming_projects.count }}</span>
                <span class="bg-orange-200 text-orange-800 text-xs px-2 py-1 rounded">On Schedule</span>
                </div>
            </div>
        </div>

    <!-- Search/Filter/Export -->
    <div class="mb-4 flex justify-between items-center">
        <div class="flex-1 max-w-md">
            <input type="text" id="searchInput" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search...">
        </div>
        <div class="ml-4">
            <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="exportData()">
                <span class="material-icons align-middle mr-1">download</span>
                Export
            </button>
        </div>
    </div>

    <!-- Tabbed Content -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center border-b mb-4 space-x-2">
            <button class="tab-btn px-4 py-2 rounded-full font-semibold text-blue-700 border-b-2 border-blue-700 bg-blue-50 focus:outline-none transition" onclick="showTab('pf')">PF Views</button>
            <button class="tab-btn px-4 py-2 rounded-full text-gray-600 hover:text-blue-700 hover:bg-blue-50 transition" onclick="showTab('bank')">Bank Account Details</button>
            <button class="tab-btn px-4 py-2 rounded-full text-gray-600 hover:text-blue-700 hover:bg-blue-50 transition" onclick="showTab('insurance')">Insurance Policy</button>
            <button class="tab-btn px-4 py-2 rounded-full text-gray-600 hover:text-blue-700 hover:bg-blue-50 transition" onclick="showTab('tax')">Income Tax Details</button>
            <button class="tab-btn px-4 py-2 rounded-full text-gray-600 hover:text-blue-700 hover:bg-blue-50 transition" onclick="showTab('personal')">Personal Details</button>
        </div>
        <!-- Table containers will use overflow-x-auto for mobile -->
        <div class="overflow-x-auto">
            <!-- All tables here (PF, Bank, Insurance, Tax, Personal) will have sticky headers, zebra striping, and hover effects -->
            <!-- Employee Table (PF Tab) -->
            <div id="tab-pf" class="tab-content">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Department</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Join Date</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTable" class="bg-white divide-y divide-gray-200">
                        {% for employee in employees %}
                        <tr>
                            <td class="px-4 py-2 flex items-center space-x-2">
                                <img src="https://ui-avatars.com/api/?name={{ employee.firstName }}+{{ employee.lastName }}" class="w-8 h-8 rounded-full" alt="Avatar">
                                <div>
                                    <div class="font-medium text-gray-800">{{ employee.firstName }} {{ employee.lastName }}</div>
                                </div>
                            </td>
                            <td class="px-4 py-2">{{ employee.email }}</td>
                            <td class="px-4 py-2">{{ employee.designation|default:'-' }}</td>
                            <td class="px-4 py-2">{{ employee.department|default:'-' }}</td>
                            <td class="px-4 py-2">
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">Active</span>
                            </td>
                            <td class="px-4 py-2">{{ employee.joinDate|date:'M d, Y' }}</td>
                            <td class="px-4 py-2 flex space-x-2">
                                {% if employee.id %}
                                    <a href="{% url 'employee_detail' employee.id %}" class="text-blue-600 hover:text-blue-900" title="View"><span class="material-icons">visibility</span></a>
                                    <a href="{% url 'edit_employee' employee.id %}" class="text-yellow-600 hover:text-yellow-900" title="Edit"><span class="material-icons">edit</span></a>
                                    <a href="{% url 'delete_employee' employee.id %}" class="text-red-600 hover:text-red-900" title="Delete"><span class="material-icons">delete</span></a>
                                {% else %}
                                    <span class="text-gray-400" title="Not available">-</span>
                                {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">No employees found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
            <!-- Bank Account Details Tab -->
            <div id="tab-bank" class="tab-content hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Account Number</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">IFSC</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in bank_details %}
                    <tr>
                        <td class="px-4 py-2 flex items-center space-x-2">
                            <img src="https://ui-avatars.com/api/?name={{ item.employee.firstName }}+{{ item.employee.lastName }}" class="w-8 h-8 rounded-full" alt="Avatar">
                            <div>{{ item.employee.firstName }} {{ item.employee.lastName }}</div>
                        </td>
                        <td class="px-4 py-2">{{ item.employee.email }}</td>
                        <td class="px-4 py-2">{{ item.employee.designation|default:'-' }}</td>
                        <td class="px-4 py-2 {% if not item.account_number %}text-red-500{% endif %}">{{ item.account_number|default:'-' }}</td>
                        <td class="px-4 py-2 {% if not item.ifsc %}text-red-500{% endif %}">{{ item.ifsc|default:'-' }}</td>
                        <td class="px-4 py-2">
                            {% if item.account_number and item.ifsc %}
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">Complete</span>
                            {% else %}
                                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">Missing Info</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2">
                            <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="openEditModal('bank', '{{ item.employee.eID }}')">Edit</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">No data found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Insurance Policy Tab -->
            <div id="tab-insurance" class="tab-content hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Policy</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in insurance_policies %}
                    <tr>
                        <td class="px-4 py-2 flex items-center space-x-2">
                            <img src="https://ui-avatars.com/api/?name={{ item.employee.firstName }}+{{ item.employee.lastName }}" class="w-8 h-8 rounded-full" alt="Avatar">
                            <div>{{ item.employee.firstName }} {{ item.employee.lastName }}</div>
                        </td>
                        <td class="px-4 py-2">{{ item.employee.email }}</td>
                        <td class="px-4 py-2">{{ item.employee.designation|default:'-' }}</td>
                        <td class="px-4 py-2">{{ item.policy }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-4 text-gray-500">No data found.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Income Tax Details Tab -->
            <div id="tab-tax" class="tab-content hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tax</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in tax_details %}
                    <tr>
                        <td class="px-4 py-2 flex items-center space-x-2">
                            <img src="https://ui-avatars.com/api/?name={{ item.employee.firstName }}+{{ item.employee.lastName }}" class="w-8 h-8 rounded-full" alt="Avatar">
                            <div>{{ item.employee.firstName }} {{ item.employee.lastName }}</div>
                        </td>
                        <td class="px-4 py-2">{{ item.employee.email }}</td>
                        <td class="px-4 py-2">{{ item.employee.designation|default:'-' }}</td>
                        <td class="px-4 py-2">{{ item.tax }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4" class="text-center py-4 text-gray-500">No data found.</td></tr>
                {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Personal Details Tab -->
            <div id="tab-personal" class="tab-content hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Employee</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Designation</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Emergency Contact Name</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Emergency Contact Phone</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in personal_details %}
                    <tr>
                        <td class="px-4 py-2 flex items-center space-x-2">
                            <img src="https://ui-avatars.com/api/?name={{ item.employee.firstName }}+{{ item.employee.lastName }}" class="w-8 h-8 rounded-full" alt="Avatar">
                            <div>{{ item.employee.firstName }} {{ item.employee.lastName }}</div>
                        </td>
                        <td class="px-4 py-2">{{ item.employee.email }}</td>
                        <td class="px-4 py-2">{{ item.employee.designation|default:'-' }}</td>
                        <td class="px-4 py-2 {% if not item.emergency_contact_name %}text-red-500{% endif %}">{{ item.emergency_contact_name|default:'-' }}</td>
                        <td class="px-4 py-2 {% if not item.emergency_contact_phone %}text-red-500{% endif %}">{{ item.emergency_contact_phone|default:'-' }}</td>
                        <td class="px-4 py-2">
                            {% if item.emergency_contact_name and item.emergency_contact_phone %}
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">Complete</span>
                            {% else %}
                                <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">Missing Info</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2">
                            <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="openEditModal('personal', '{{ item.employee.eID }}')">Edit</button>
                        </td>
                    </tr>
            {% empty %}
                    <tr><td colspan="7" class="text-center py-4 text-gray-500">No data found.</td></tr>
                {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- JS for sidebar and tabs -->
<script>
let currentTab = 'pf';

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active state from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('text-blue-700', 'border-b-2', 'border-blue-700', 'bg-blue-50');
        btn.classList.add('text-gray-600');
    });
    
    // Show selected tab content
    document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    
    // Add active state to selected tab button
    const activeBtn = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    activeBtn.classList.remove('text-gray-600');
    activeBtn.classList.add('text-blue-700', 'border-b-2', 'border-blue-700', 'bg-blue-50');
    
    currentTab = tabName;
    // Reset search when changing tabs
    document.getElementById('searchInput').value = '';
    filterTable();
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const currentTable = document.getElementById(`tab-${currentTab}`);
    const rows = currentTable.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        for (let cell of cells) {
            if (cell.textContent.toLowerCase().includes(searchTerm)) {
                found = true;
                break;
            }
        }
        
        row.style.display = found ? '' : 'none';
    }
}

function exportData() {
    const currentTable = document.getElementById(`tab-${currentTab}`);
    const rows = Array.from(currentTable.getElementsByTagName('tr'));
    
    // Get headers
    const headers = Array.from(rows[0].getElementsByTagName('th'))
        .map(header => header.textContent.trim());
    
    // Get data rows
    const data = rows.slice(1).map(row => {
        return Array.from(row.getElementsByTagName('td'))
            .map(cell => cell.textContent.trim());
    });
    
    // Create CSV content
    let csvContent = headers.join(',') + '\n';
    data.forEach(row => {
        csvContent += row.join(',') + '\n';
    });
    
    // Create and trigger download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${currentTab}_data.csv`;
    link.click();
}

// Add event listener for search input
document.getElementById('searchInput').addEventListener('input', filterTable);

// Show initial tab
showTab('pf');
</script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
    .dashboard-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    .tab-btn {
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    .tab-btn:hover {
        background-color: #e2e8f0;
    }
    .tab-content {
        transition: opacity 0.3s ease;
    }
    .tab-content.hidden {
        opacity: 0;
    }
    .tab-content:not(.hidden) {
        opacity: 1;
    }
</style>
{% endblock %} 